<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-auth.js";
    import { connectFirestoreEmulator, orderBy, limit, getFirestore, setDoc, addDoc, doc, updateDoc, deleteDoc, getDoc, query, collection, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js";
  
    const firebaseConfig = {
        apiKey: "AIzaSyCzf803qRjCMmK9wGhzPs68WLUZKr-M42M",
        authDomain: "casestudy-1c77a.firebaseapp.com",
        projectId: "casestudy-1c77a",
        storageBucket: "casestudy-1c77a.appspot.com",
        messagingSenderId: "743404711750",
        appId: "1:743404711750:web:fffdbd353973f645397f47",
        measurementId: "G-YX6H49NVFB"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    console.log(app);
    firebase.initializeApp(firebaseConfig);
  
    // Total number of Inputted data
    document.addEventListener("DOMContentLoaded", async function() {
      const querySnapshot = await getDocs(collection(db, "covid-test"));
      const totalInputs = querySnapshot.size;
      console.log('count: ', totalInputs);
      document.getElementById("total-input").innerHTML = `${totalInputs}<br><span>Total Inputs</span>`;
    });
  
    // Total number of Unique location
    document.addEventListener("DOMContentLoaded", async function() {
      const querySnapshot = await getDocs(collection(db, "covid-test"));
      const uniqueLocations = new Set();
  
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        uniqueLocations.add(data.Location);
      });
  
      const totalLocations = uniqueLocations.size;
      console.log('count: ', totalLocations);
      document.getElementById("total-location").innerHTML = `${totalLocations}<br><span>Total Countries</span>`;

            /**
       * IF ALL RECORDS IMO WANT I RECORD
       *     //Total number of Countries
        document.addEventListener("DOMContentLoaded", async function() {
        const q = query(collection(db, "covid-test"));
        const querySnapshot = await getDocs(q).then((snapshot) => {
          if (!snapshot.empty) {
            const totalLocations = snapshot.docs.length;
            console.log('count: ', totalLocations);
            document.getElementById("total-location").innerHTML = `${totalLocations}<br><span>All Records</span>`;
          } else {
            console.log('No documents found');
          }
        });
      */
  
      const collectionRef = collection(db, 'covid-test');
      const queryRef = query(collectionRef);
      let totalCases = 0;
      let totalDeaths = 0;
  
      // recording the total cases
      getDocs(queryRef)
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const cases = parseInt(data.NewCases);
            totalCases += cases;
          });
          console.log('Total Cases:', totalCases);
  
          const formattedTotalCases = formatNumber(totalCases);
          document.getElementById("total-cases").innerHTML = `${formattedTotalCases}<br><span>Total Cases</span>`;
        })
        .catch((error) => {
          console.log('Error getting documents:', error);
        });
  
      // recording the total deaths
      getDocs(queryRef)
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const deaths = parseInt(data.NewDeaths);
            totalDeaths += deaths;
          });
          console.log('Total Deaths:', totalDeaths);
  
          const formattedTotalDeaths = formatNumber(totalDeaths);
          document.getElementById("total-deaths").innerHTML = `${formattedTotalDeaths}<br><span>Total Deaths</span>`;
        })
        .catch((error) => {
          console.log('Error getting documents:', error);
        });
  
      // Getting Covid data and append it to the data table
      /**
       * TODO: Add code for getting Covid data and appending it to the table
       */
  
      // Fetch the data from Firebase and update the bar chart for total new cases
      async function updateBarChartCases() {
        const querySnapshot = await getDocs(collection(db, "covid-test"));
        const locationData = {};
  
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const location = data.Location;
          const newCases = parseInt(data.NewCases);
  
          if (locationData[location]) {
            locationData[location] += newCases;
          } else {
            locationData[location] = newCases;
          }
        });
  
        const locations = Object.keys(locationData).sort(); // Sort locations alphabetically
        const totalCases = Object.values(locationData);
  
        // Create the bar chart for total new cases
        new Chart(document.getElementById('bar-chart-cases'), {
          type: 'bar',
          data: {
            labels: locations,
            datasets: [{
              label: 'Total New Cases',
              data: totalCases,
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
            }],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Total New Cases',
                },
              },
            },
          },
        });
      }
  
      // Call the updateBarChartCases function to initialize the bar chart for total new cases
      updateBarChartCases();
  
      // Fetch the data from Firebase and update the bar chart for total new deaths
      async function updateBarChartDeaths() {
        const querySnapshot = await getDocs(collection(db, "covid-test"));
        const locationData = {};
  
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const location = data.Location;
          const newDeaths = parseInt(data.NewDeaths);
  
          if (locationData[location]) {
            locationData[location] += newDeaths;
          } else {
            locationData[location] = newDeaths;
          }
        });
  
        const locations = Object.keys(locationData).sort(); // Sort locations alphabetically
        const totalDeaths = Object.values(locationData);
  
        // Create the bar chart for total new deaths
        new Chart(document.getElementById('bar-chart-deaths'), {
          type: 'bar',
          data: {
            labels: locations,
            datasets: [{
              label: 'Total New Deaths',
              data: totalDeaths,
              backgroundColor: 'rgba(255, 99, 132, 0.6)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1,
            }],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Total New Deaths',
                },
              },
            },
          },
        });
      }
  
      // Call the updateBarChartDeaths function to initialize the bar chart for total new deaths
      updateBarChartDeaths();
    }); // nag end ang DOMContentLoaded
  
    function formatNumber(num) {
      const billion = 1000000000;
      const million = 1000000;
  
      if (num >= billion) {
        return (num / billion).toFixed(1) + 'B';
      } else if (num >= million) {
        return (num / million).toFixed(0) + 'M';
      } else {
        return num.toString();
      }
    }
  </script>
  